from flask import Flask, jsonify, request
from flask_cors import CORS
import pandas as pd
import numpy as np
from sklearn.ensemble import GradientBoostingRegressor
import pickle

app = Flask(__name__)
CORS(app)

# Load your trained model
# model = pickle.load(open('olympic_model.pkl', 'rb'))

@app.route('/predict', methods=['POST'])
def predict():
    # Get the year from the request
    year = int(request.json['year'])
    
    # Load your dataset
    df = pd.read_csv('cleaned_athlete_events_gdp_n_pop.csv')
    
    # Sort data to ensure chronological order by country and year
    df = df.sort_values(by=['Country_Name', 'Year'])
    
    # Shift the "Total" column by one Olympic cycle (4 years)
    df['Past_Total'] = df.groupby('Country_Name')['Total'].shift(1)
    
    # Drop rows where Past_Total is NaN
    df = df.dropna(subset=['Past_Total'])
    
    # Select features and target
    features = ['GDP_USD', 'GDP_per_capita_USD', 'Population', 'Past_Total']
    
    # Prepare prediction data
    data_future = df[df['Year'] == 2024].copy()
    data_future['Year'] = year
    data_future['Past_Total'] = data_future['Total']
    
    # Make predictions
    X_future = data_future[features]
    predictions = model.predict(X_future)
    
    # Prepare response data
    response_data = {
        'predictions': [
            {
                'Country_Name': country,
                'Total': actual,
                'Predicted_Total': pred
            }
            for country, actual, pred in zip(
                data_future['Country_Name'],
                data_future['Total'],
                predictions
            )
        ],
        'feature_importance': [
            {
                'feature': feature,
                'importance': importance
            }
            for feature, importance in zip(
                features,
                model.feature_importances_
            )
        ]
    }
    
    return jsonify(response_data)

if __name__ == '__main__':
    app.run(debug=True)
    